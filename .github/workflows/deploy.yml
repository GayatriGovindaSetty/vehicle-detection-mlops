name: Deploy to Hugging Face

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'src/**'
      - 'config/**'
      - 'docker/Dockerfile'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Hugging Face Spaces
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub[cli]
        
    - name: Verify huggingface-cli installation
      run: |
        which huggingface-cli || echo "huggingface-cli not in PATH"
        python -c "import huggingface_hub; print(f'huggingface_hub version: {huggingface_hub.__version__}')"
    
    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
    
    - name: Verify deployment configuration
      run: |
        echo "üìã Deployment Configuration:"
        echo "   HF Username: ${{ secrets.HF_USERNAME }}"
        echo "   Target Space: ${{ secrets.HF_USERNAME }}/vehicle-detection"
        echo "   Model source: Hugging Face Hub (downloaded at runtime)"
        echo ""
        echo "‚úÖ No local model file needed - model will be downloaded from HF Hub"
    
    - name: Create Hugging Face Space README
      run: |
        cat > README.md << 'EOF'
        ---
        title: Vehicle Detection System
        emoji: üöó
        colorFrom: blue
        colorTo: green
        sdk: docker
        pinned: false
        license: mit
        ---
        
        # üöó Real-Time Vehicle Detection System
        
        This space demonstrates real-time vehicle detection using YOLOv8.
        
        ## Features
        - Detect 8 classes of vehicles: Auto, Bus, Car, LCV, Motorcycle, Multiaxle, Tractor, Truck
        - Process images and videos in real-time
        - Adjustable confidence and IOU thresholds
        - Powered by YOLOv8 Nano (~50 FPS on GPU)
        
        ## Usage
        1. **Image Detection:** Upload an image and click "Detect Vehicles"
        2. **Video Detection:** Upload a video and click "Process Video"
        3. Adjust detection parameters as needed
        
        ## Model
        The trained model is automatically downloaded from Hugging Face Hub at startup.
        
        ## Performance
        - **Speed:** ~50 FPS on GPU, ~10 FPS on CPU
        - **Accuracy:** mAP@0.5 > 85%
        - **Model Size:** ~6 MB
        
        Built with Ultralytics YOLOv8, Gradio, and Docker.
        
        ## Source Code
        [GitHub Repository](https://github.com/yourusername/vehicle-detection-mlops)
        EOF
    
    - name: Push to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
      run: |
        # Verify secrets are set
        if [ -z "$HF_TOKEN" ] || [ -z "$HF_USERNAME" ]; then
          echo "‚ùå Error: HF_TOKEN or HF_USERNAME not set in GitHub Secrets"
          echo "Please add them in: Settings ‚Üí Secrets and variables ‚Üí Actions"
          exit 1
        fi
        
        SPACE_NAME="${HF_USERNAME}/vehicle-detection"
        
        echo "üöÄ Deploying to Hugging Face Space: $SPACE_NAME"
        
        # Login to Hugging Face using Python API
        python << 'PYTHON_SCRIPT'
        import os
        from huggingface_hub import HfApi, login
        
        token = os.environ['HF_TOKEN']
        login(token=token, add_to_git_credential=True)
        print("‚úÖ Logged in to Hugging Face")
        PYTHON_SCRIPT
        
        # Check if space exists using Python API
        python << 'PYTHON_SCRIPT'
        import os
        import sys
        from huggingface_hub import HfApi
        
        api = HfApi()
        space_name = os.environ['SPACE_NAME']
        
        try:
            api.repo_info(repo_id=space_name, repo_type="space")
            print(f"‚úÖ Space exists: {space_name}")
        except Exception as e:
            print(f"‚ùå Space does not exist: {space_name}")
            print(f"Error: {e}")
            print("")
            print("Please create it manually at: https://huggingface.co/new-space")
            print("Space name: vehicle-detection")
            print("SDK: Docker")
            sys.exit(1)
        PYTHON_SCRIPT
        
        # Clone the space
        echo "üì• Cloning Space..."
        git clone https://huggingface.co/spaces/$SPACE_NAME hf-space
        
        cd hf-space
        
        # Copy application files (NO models/ directory - model downloads from HF Hub)
        echo "üì¶ Copying application files..."
        mkdir -p app src config
        
        cp -r ../app/* ./app/ 2>/dev/null || cp -r ../app ./
        cp -r ../src/* ./src/ 2>/dev/null || cp -r ../src ./
        cp -r ../config/* ./config/ 2>/dev/null || cp -r ../config ./
        cp ../docker/Dockerfile ./Dockerfile
        cp ../requirements.txt .
        cp ../README.md .
        
        # Create .dockerignore
        cat > .dockerignore << 'DOCKERIGNORE'
        __pycache__
        *.pyc
        *.pyo
        *.pyd
        .Python
        .git
        .github
        .gitignore
        *.md
        tests/
        notebooks/
        data/
        logs/
        models/
        .venv
        venv/
        ENV/
        DOCKERIGNORE
        
        echo ""
        echo "üìÑ Files to deploy:"
        ls -la
        echo ""
        echo "üìÅ Directory structure:"
        find . -type d -maxdepth 2 | grep -v ".git"
        echo ""
        
        # Commit and push
        git add .
        
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è  No changes to deploy"
        else
          git commit -m "Deploy from GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S') - SHA: ${{ github.sha }}"
          
          # Push with authentication
          git push https://user:${HF_TOKEN}@huggingface.co/spaces/$SPACE_NAME main
          
          echo "‚úÖ Deployment successful!"
        fi
    
    - name: Deployment Summary
      if: success()
      run: |
        echo ""
        echo "üéâ ================================"
        echo "üéâ DEPLOYMENT SUCCESSFUL!"
        echo "üéâ ================================"
        echo ""
        echo "üåê Your app is live at:"
        echo "   https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/vehicle-detection"
        echo ""
        echo "‚è≥ First startup timeline:"
        echo "   1. Docker image building: ~3-5 minutes"
        echo "   2. Model download from HF Hub: ~30 seconds"
        echo "   3. App initialization: ~10 seconds"
        echo "   Total: ~5-6 minutes for first deployment"
        echo ""
        echo "üìù Next steps:"
        echo "   1. Wait for Space to finish building"
        echo "   2. Check Space logs if any issues"
        echo "   3. Test with sample images/videos"
        echo ""
    
    - name: Notify on failure
      if: failure()
      run: |
        echo ""
        echo "‚ùå ================================"
        echo "‚ùå DEPLOYMENT FAILED"
        echo "‚ùå ================================"
        echo ""
        echo "Common issues:"
        echo "1. GitHub Secrets not set:"
        echo "   - Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
        echo "   - Add: HF_TOKEN (your Hugging Face token)"
        echo "   - Add: HF_USERNAME (your Hugging Face username)"
        echo ""
        echo "2. Space doesn't exist:"
        echo "   - Create at: https://huggingface.co/new-space"
        echo "   - Name: vehicle-detection"
        echo "   - SDK: Docker (IMPORTANT!)"
        echo "   - Visibility: Public"
        echo ""
        echo "3. Token permissions:"
        echo "   - Token must have WRITE access"
        echo "   - Regenerate at: https://huggingface.co/settings/tokens"
        echo ""
        echo "4. Space SDK incorrect:"
        echo "   - Must be 'Docker', not 'Gradio' or 'Streamlit'"
        echo ""
        echo "Please check the logs above for specific errors."
        echo ""

  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Final Status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/vehicle-detection"
        else
          echo "‚ùå Deployment failed - check deploy job logs for details"
        fi
