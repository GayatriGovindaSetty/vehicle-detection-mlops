name: Deploy to Hugging Face

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'src/**'
      - 'config/**'
      - 'docker/Dockerfile'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Hugging Face Spaces
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub
    
    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
    
    - name: Verify deployment configuration
      run: |
        echo "ðŸ“‹ Deployment Configuration:"
        echo "   HF Username: ${{ secrets.HF_USERNAME }}"
        echo "   Target Space: ${{ secrets.HF_USERNAME }}/vehicle-detection"
        echo "   Model source: Hugging Face Hub (downloaded at runtime)"
        echo ""
        echo "âœ… No local model file needed - model will be downloaded from HF Hub"
    
    - name: Create Hugging Face Space README
      run: |
        cat > README.md << 'EOF'
        ---
        title: Vehicle Detection System
        emoji: ðŸš—
        colorFrom: blue
        colorTo: green
        sdk: docker
        pinned: false
        license: mit
        ---
        
        # ðŸš— Real-Time Vehicle Detection System
        
        This space demonstrates real-time vehicle detection using YOLOv8.
        
        ## Features
        - Detect 8 classes of vehicles: Auto, Bus, Car, LCV, Motorcycle, Multiaxle, Tractor, Truck
        - Process images and videos in real-time
        - Adjustable confidence and IOU thresholds
        - Powered by YOLOv8 Nano (~50 FPS on GPU)
        
        ## Usage
        1. **Image Detection:** Upload an image and click "Detect Vehicles"
        2. **Video Detection:** Upload a video and click "Process Video"
        3. Adjust detection parameters as needed
        
        ## Model
        The trained model is automatically downloaded from Hugging Face Hub at startup.
        
        ## Performance
        - **Speed:** ~50 FPS on GPU, ~10 FPS on CPU
        - **Accuracy:** mAP@0.5 > 85%
        - **Model Size:** ~6 MB
        
        Built with Ultralytics YOLOv8, Gradio, and Docker.
        
        ## Source Code
        [GitHub Repository](https://github.com/GayatriGovindaSetty/vehicle-detection-mlops)
        EOF
    
    - name: Push to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
      run: |
        # Verify secrets are set
        if [ -z "$HF_TOKEN" ] || [ -z "$HF_USERNAME" ]; then
          echo "âŒ Error: HF_TOKEN or HF_USERNAME not set in GitHub Secrets"
          echo "Please add them in: Settings â†’ Secrets and variables â†’ Actions"
          exit 1
        fi
        
        SPACE_NAME="${HF_USERNAME}/vehicle-detection"
        
        echo "ðŸš€ Deploying to Hugging Face Space: $SPACE_NAME"
        
        # Login to Hugging Face
        huggingface-cli login --token $HF_TOKEN
        
        # Check if space exists
        if huggingface-cli repo info "$SPACE_NAME" --repo-type space >/dev/null 2>&1; then
          echo "âœ… Space exists, cloning..."
          git clone https://huggingface.co/spaces/$SPACE_NAME hf-space
        else
          echo "âŒ Space does not exist!"
          echo "Please create it manually at: https://huggingface.co/new-space"
          echo "Space name: vehicle-detection"
          echo "SDK: Docker"
          exit 1
        fi
        
        cd hf-space
        
        # Copy application files (NO models/ directory - model downloads from HF Hub)
        echo "ðŸ“¦ Copying application files..."
        mkdir -p app src config
        
        cp -r ../app/* ./app/ 2>/dev/null || cp -r ../app ./
        cp -r ../src/* ./src/ 2>/dev/null || cp -r ../src ./
        cp -r ../config/* ./config/ 2>/dev/null || cp -r ../config ./
        cp ../docker/Dockerfile ./Dockerfile
        cp ../requirements.txt .
        cp ../README.md .
        
        # Create .dockerignore
        cat > .dockerignore << 'DOCKERIGNORE'
        __pycache__
        *.pyc
        *.pyo
        *.pyd
        .Python
        .git
        .github
        .gitignore
        *.md
        tests/
        notebooks/
        data/
        logs/
        models/
        .venv
        venv/
        ENV/
        DOCKERIGNORE
        
        echo ""
        echo "ðŸ“„ Files to deploy:"
        ls -la
        echo ""
        echo "ðŸ“ Directory structure:"
        find . -type d -maxdepth 2 | grep -v ".git"
        echo ""
        
        # Commit and push
        git add .
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes to deploy"
        else
          git commit -m "Deploy from GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S') - SHA: ${{ github.sha }}"
          
          # Push with authentication
          git push https://user:${HF_TOKEN}@huggingface.co/spaces/$SPACE_NAME main
          
          echo "âœ… Deployment successful!"
        fi
    
    - name: Deployment Summary
      if: success()
      run: |
        echo ""
        echo "ðŸŽ‰ ================================"
        echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
        echo "ðŸŽ‰ ================================"
        echo ""
        echo "ðŸŒ Your app is live at:"
        echo "   https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/vehicle-detection"
        echo ""
        echo "â³ First startup timeline:"
        echo "   1. Docker image building: ~3-5 minutes"
        echo "   2. Model download from HF Hub: ~30 seconds"
        echo "   3. App initialization: ~10 seconds"
        echo "   Total: ~5-6 minutes for first deployment"
        echo ""
        echo "ðŸ“ Next steps:"
        echo "   1. Wait for Space to finish building"
        echo "   2. Check Space logs if any issues"
        echo "   3. Test with sample images/videos"
        echo ""
    
    - name: Notify on failure
      if: failure()
      run: |
        echo ""
        echo "âŒ ================================"
        echo "âŒ DEPLOYMENT FAILED"
        echo "âŒ ================================"
        echo ""
        echo "Common issues:"
        echo "1. GitHub Secrets not set:"
        echo "   - Go to: Settings â†’ Secrets and variables â†’ Actions"
        echo "   - Add: HF_TOKEN (your Hugging Face token)"
        echo "   - Add: HF_USERNAME (your Hugging Face username)"
        echo ""
        echo "2. Space doesn't exist:"
        echo "   - Create at: https://huggingface.co/new-space"
        echo "   - Name: vehicle-detection"
        echo "   - SDK: Docker (IMPORTANT!)"
        echo "   - Visibility: Public"
        echo ""
        echo "3. Token permissions:"
        echo "   - Token must have WRITE access"
        echo "   - Regenerate at: https://huggingface.co/settings/tokens"
        echo ""
        echo "4. Space SDK incorrect:"
        echo "   - Must be 'Docker', not 'Gradio' or 'Streamlit'"
        echo ""
        echo "Please check the logs above for specific errors."
        echo ""

  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Final Status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/vehicle-detection"
        else
          echo "âŒ Deployment failed - check deploy job logs for details"
        fi
