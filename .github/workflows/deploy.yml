name: Deploy to Hugging Face

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'src/**'
      - 'models/**'
      - 'Dockerfile'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Hugging Face Spaces
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        lfs: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub
    
    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
    
    - name: Check if model exists
      id: check_model
      run: |
        if [ -f "models/best.pt" ]; then
          echo "model_exists=true" >> $GITHUB_OUTPUT
        else
          echo "model_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Download model from artifacts (if needed)
      if: steps.check_model.outputs.model_exists == 'false'
      run: |
        echo "Model not found. You need to train the model first."
        echo "Please upload the trained model to models/best.pt"
        exit 1
    
    - name: Create Hugging Face Space files
      run: |
        # Create README.md for Hugging Face
        cat > README.md << 'EOF'
        ---
        title: Vehicle Detection System
        emoji: üöó
        colorFrom: blue
        colorTo: green
        sdk: docker
        pinned: false
        license: mit
        ---
        
        # Real-Time Vehicle Detection System
        
        This space demonstrates real-time vehicle detection using YOLOv8.
        
        ## Features
        - Detect 8 classes of vehicles
        - Process images and videos
        - Adjustable confidence and IOU thresholds
        
        ## Classes
        Auto, Bus, Car, LCV, Motorcycle, Multiaxle, Tractor, Truck
        
        ## Usage
        1. Upload an image or video
        2. Adjust detection parameters
        3. Click "Detect Vehicles" or "Process Video"
        
        Built with Ultralytics YOLOv8, Gradio, and Docker.
        EOF
    
    - name: Push to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        # Install git-lfs if not already installed
        sudo apt-get install git-lfs
        git lfs install
        
        # Clone or create the space
        SPACE_NAME="${{ secrets.HF_USERNAME }}/vehicle-detection"
        
        # Login to Hugging Face
        huggingface-cli login --token $HF_TOKEN
        
        # Clone the space (or create if it doesn't exist)
        if huggingface-cli repo info "$SPACE_NAME" >/dev/null 2>&1; then
          echo "Space exists, cloning..."
          git clone https://huggingface.co/spaces/$SPACE_NAME hf-space
        else
          echo "Creating new space..."
          huggingface-cli repo create --type space --space_sdk docker $SPACE_NAME
          git clone https://huggingface.co/spaces/$SPACE_NAME hf-space
        fi
        
        cd hf-space
        
        # Copy files
        cp -r ../app ../src ../models ../Dockerfile ../requirements.txt .
        cp ../README.md .
        
        # Track large files with git-lfs
        git lfs track "*.pt"
        git add .gitattributes
        
        # Commit and push
        git add .
        git commit -m "Deploy from GitHub Actions - ${{ github.sha }}" || echo "No changes to commit"
        git push https://user:$HF_TOKEN@huggingface.co/spaces/$SPACE_NAME main
    
    - name: Update deployment status
      if: success()
      run: |
        echo "üöÄ Deployment successful!"
        echo "View your space at: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/vehicle-detection"
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Deployment failed. Please check the logs."

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Send deployment notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "‚úÖ Deployment to Hugging Face successful!"
        else
          echo "‚ùå Deployment to Hugging Face failed!"
        fi