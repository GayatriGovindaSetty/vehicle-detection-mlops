name: Deploy to Hugging Face

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'src/**'
      - 'config/**'
      - 'docker/Dockerfile'
      - 'requirements.txt'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Hugging Face Spaces
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub
    
    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
    
    # REMOVED: Model existence check since model is on Hugging Face now
    # The app will download the model from HF at runtime
    
    - name: Create Hugging Face Space files
      run: |
        # Create README.md for Hugging Face Space
        cat > README.md << 'EOF'
        ---
        title: Vehicle Detection System
        emoji: ðŸš—
        colorFrom: blue
        colorTo: green
        sdk: docker
        pinned: false
        license: mit
        ---
        
        # ðŸš— Real-Time Vehicle Detection System
        
        This space demonstrates real-time vehicle detection using YOLOv8.
        
        ## Features
        - Detect 8 classes of vehicles: Auto, Bus, Car, LCV, Motorcycle, Multiaxle, Tractor, Truck
        - Process images and videos in real-time
        - Adjustable confidence and IOU thresholds
        - Powered by YOLOv8 Nano (~50 FPS on GPU)
        
        ## Usage
        1. **Image Detection:** Upload an image and click "Detect Vehicles"
        2. **Video Detection:** Upload a video and click "Process Video"
        3. Adjust detection parameters as needed
        
        ## Model
        The trained model is automatically downloaded from Hugging Face Hub at startup.
        
        ## Performance
        - **Speed:** ~50 FPS on GPU, ~10 FPS on CPU
        - **Accuracy:** mAP@0.5 > 85%
        - **Model Size:** ~6 MB
        
        Built with Ultralytics YOLOv8, Gradio, and Docker.
        
        ## Source Code
        [GitHub Repository](https://github.com/yourusername/vehicle-detection-mlops)
        EOF
    
    - name: Push to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
      run: |
        # Verify secrets are set
        if [ -z "$HF_TOKEN" ] || [ -z "$HF_USERNAME" ]; then
          echo "âŒ Error: HF_TOKEN or HF_USERNAME not set in GitHub Secrets"
          echo "Please add them in: Settings â†’ Secrets and variables â†’ Actions"
          exit 1
        fi
        
        SPACE_NAME="${HF_USERNAME}/vehicle-detection"
        
        echo "ðŸš€ Deploying to Hugging Face Space: $SPACE_NAME"
        
        # Login to Hugging Face
        huggingface-cli login --token $HF_TOKEN
        
        # Check if space exists
        if huggingface-cli repo info "$SPACE_NAME" --repo-type space >/dev/null 2>&1; then
          echo "âœ… Space exists, cloning..."
          git clone https://huggingface.co/spaces/$SPACE_NAME hf-space
        else
          echo "âŒ Space does not exist!"
          echo "Please create it manually at: https://huggingface.co/new-space"
          echo "Space name: vehicle-detection"
          echo "SDK: Docker"
          exit 1
        fi
        
        cd hf-space
        
        # Copy application files (NOT models/ since model is on HF Hub)
        echo "ðŸ“¦ Copying files..."
        cp -r ../app .
        cp -r ../src .
        cp -r ../config .
        cp ../docker/Dockerfile ./Dockerfile
        cp ../requirements.txt .
        cp ../README.md .
        
        # Create .dockerignore if not exists
        cat > .dockerignore << 'DOCKERIGNORE'
        __pycache__
        *.pyc
        *.pyo
        *.pyd
        .Python
        .git
        .github
        .gitignore
        *.md
        tests/
        notebooks/
        data/
        logs/
        .venv
        venv/
        ENV/
        DOCKERIGNORE
        
        # Show what we're deploying
        echo "ðŸ“„ Files to deploy:"
        ls -la
        
        # Commit and push
        git add .
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes to deploy"
        else
          git commit -m "Deploy from GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S') - SHA: ${{ github.sha }}"
          
          # Push with authentication
          git push https://user:${HF_TOKEN}@huggingface.co/spaces/$SPACE_NAME main
          
          echo "âœ… Deployment successful!"
        fi
    
    - name: Update deployment status
      if: success()
      run: |
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo "ðŸŒ View your space at: https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/vehicle-detection"
        echo ""
        echo "â³ Note: First startup may take 1-2 minutes while model downloads from Hugging Face Hub"
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo ""
        echo "Common issues:"
        echo "1. HF_TOKEN or HF_USERNAME not set in GitHub Secrets"
        echo "2. Space doesn't exist - create manually at https://huggingface.co/new-space"
        echo "3. Space SDK is not set to 'Docker'"
        echo "4. Token doesn't have write permissions"
        echo ""
        echo "Please check the logs above for specific errors"

  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Send deployment notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… ================================"
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "âœ… ================================"
          echo ""
          echo "ðŸŒ Your app is live at:"
          echo "   https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/vehicle-detection"
          echo ""
          echo "ðŸ“ Next steps:"
          echo "   1. Wait 1-2 minutes for first startup"
          echo "   2. Model will download from Hugging Face Hub automatically"
          echo "   3. Test the app with sample images/videos"
          echo ""
        else
          echo "âŒ ================================"
          echo "âŒ DEPLOYMENT FAILED"
          echo "âŒ ================================"
          echo ""
          echo "Please check the deployment job logs for details"
          echo ""
          echo "Troubleshooting:"
          echo "   1. Verify GitHub Secrets are set (HF_TOKEN, HF_USERNAME)"
          echo "   2. Ensure Space exists at https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/vehicle-detection"
          echo "   3. Verify Space SDK is set to 'Docker'"
          echo "   4. Check token has write permissions"
          echo ""
        fi
